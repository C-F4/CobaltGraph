<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CobaltGraph GeoWatchfloor</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            background: #0a0a0a;
            color: #e0e0e0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header - Minimal */
        .header {
            background: #111;
            border-bottom: 1px solid #333;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 14px;
            font-weight: 600;
            color: #00ff88;
            letter-spacing: 2px;
        }

        .status {
            display: flex;
            gap: 20px;
            font-size: 11px;
            color: #888;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #00ff88;
        }

        .heartbeat-time {
            font-family: 'SF Mono', monospace;
            color: #00ff88;
            font-weight: 600;
        }

        /* Main Layout */
        .main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Map - 70% */
        .map-container {
            flex: 7;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* Sidebar - 30% */
        .sidebar {
            flex: 3;
            background: #0f0f0f;
            border-left: 1px solid #222;
            overflow-y: auto;
            padding: 20px;
        }

        /* Section */
        .section {
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 10px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }

        /* Metrics */
        .metric {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 12px;
            border-bottom: 1px solid #1a1a1a;
        }

        .metric-label {
            color: #888;
        }

        .metric-value {
            color: #e0e0e0;
            font-weight: 600;
        }

        /* Connections List */
        .connection-item {
            padding: 10px;
            background: #141414;
            border-radius: 4px;
            margin-bottom: 8px;
            font-size: 11px;
            line-height: 1.6;
        }

        .connection-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .connection-ip {
            color: #00ff88;
            font-family: monospace;
        }

        .connection-country {
            color: #888;
            font-size: 10px;
        }

        .connection-meta {
            color: #666;
            font-size: 10px;
        }

        /* Unknown Locations */
        .unknown-item {
            padding: 8px 10px;
            background: #1a1a14;
            border-left: 3px solid #ffaa44;
            margin-bottom: 8px;
            font-size: 11px;
        }

        .unknown-ip {
            color: #ffaa44;
            font-family: monospace;
            font-weight: 600;
        }

        .unknown-meta {
            color: #888;
            font-size: 10px;
            margin-top: 4px;
        }

        /* Threat Zones */
        .threat-zone {
            padding: 8px 10px;
            background: #1a1414;
            border-left: 3px solid #ff4444;
            margin-bottom: 8px;
            font-size: 11px;
        }

        .threat-score {
            color: #ff4444;
            font-weight: 600;
        }

        .threat-location {
            color: #888;
            font-size: 10px;
            margin-top: 4px;
        }

        /* Health Bar */
        .health-bar {
            height: 4px;
            background: #1a1a1a;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 8px;
        }

        .health-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff4444, #ffaa44, #00ff88);
            transition: width 0.3s ease;
        }

        /* Scrollbar */
        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: #0a0a0a;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 3px;
        }

        /* Leaflet Customization */
        .leaflet-container {
            background: #0a0a0a;
        }

        .leaflet-popup-content-wrapper {
            background: #141414;
            color: #e0e0e0;
            border-radius: 4px;
            font-size: 11px;
        }

        .leaflet-popup-tip {
            background: #141414;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>CobaltGraph GEOWATCHFLOOR</h1>
        <div class="status">
            <div class="status-item">
                <div class="status-dot"></div>
                <span id="status-text">Active</span>
            </div>
            <div class="status-item">
                <span class="heartbeat-time" id="heartbeat-time">--:--:--</span>
            </div>
            <div class="status-item">
                <span id="connection-count">0 connections</span>
            </div>
            <div class="status-item">
                <span id="data-age" style="color: #00ff88;">Live</span>
            </div>
            <div class="status-item">
                <span id="health-text">Health: 0%</span>
            </div>
        </div>
    </div>

    <!-- Main Layout -->
    <div class="main">
        <!-- Map -->
        <div class="map-container">
            <div id="map"></div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
            <!-- System Health -->
            <div class="section">
                <div class="section-title">System Health</div>
                <div id="system-health">
                    <div class="health-bar">
                        <div class="health-fill" id="health-fill" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Key Metrics -->
            <div class="section">
                <div class="section-title">Metrics</div>
                <div id="metrics">
                    <div class="metric">
                        <span class="metric-label">Connections</span>
                        <span class="metric-value" id="metric-connections">0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Countries</span>
                        <span class="metric-value" id="metric-countries">0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Threat Zones</span>
                        <span class="metric-value" id="metric-threats">0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Database</span>
                        <span class="metric-value" id="metric-db">Active</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Geo Queue</span>
                        <span class="metric-value" id="metric-queue">0</span>
                    </div>
                </div>
            </div>

            <!-- Unknown Locations -->
            <div class="section">
                <div class="section-title">Unknown Locations</div>
                <div id="unknown-locations"></div>
            </div>

            <!-- Threat Zones -->
            <div class="section">
                <div class="section-title">Active Threats</div>
                <div id="threat-zones"></div>
            </div>

            <!-- Recent Connections -->
            <div class="section">
                <div class="section-title">Recent Connections</div>
                <div id="connections"></div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Map
        const map = L.map('map', {
            zoomControl: true,
            attributionControl: false
        }).setView([20, 0], 2);

        // Dark tile layer
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 19
        }).addTo(map);

        // Connection markers - track by key for efficient updates
        let markers = new Map(); // key -> marker object
        let threatCircles = new Map(); // key -> circle object

        // Fetch and update data
        async function updateDashboard() {
            try {
                console.log('Fetching data...');
                const response = await fetch('/api/data');
                const data = await response.json();
                console.log('Data received:', data);

                // Update heartbeat time synchronized to system timestamp
                const timestamp = new Date(data.timestamp * 1000);
                const timeStr = timestamp.toLocaleTimeString('en-US', {
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                document.getElementById('heartbeat-time').textContent = timeStr;

                // Update header status
                document.getElementById('connection-count').textContent =
                    `${data.connections?.length || 0} connections`;

                // Update data age indicator
                const bufferAge = data.metrics?.buffer_age;
                const ageElement = document.getElementById('data-age');
                if (bufferAge === null || bufferAge === undefined) {
                    ageElement.textContent = 'No Data';
                    ageElement.style.color = '#666';
                } else if (bufferAge < 10) {
                    ageElement.textContent = 'Live';
                    ageElement.style.color = '#00ff88';
                } else if (bufferAge < 60) {
                    ageElement.textContent = `${Math.floor(bufferAge)}s ago`;
                    ageElement.style.color = '#ffaa44';
                } else {
                    const minutes = Math.floor(bufferAge / 60);
                    ageElement.textContent = `${minutes}m ago`;
                    ageElement.style.color = '#ff4444';
                }

                // Update health
                const health = (data.system_health?.overall || 0) * 100;
                document.getElementById('health-text').textContent = `Health: ${health.toFixed(0)}%`;
                document.getElementById('health-fill').style.width = `${health}%`;

                // Update metrics
                document.getElementById('metric-connections').textContent =
                    data.connections?.length || 0;

                const countries = new Set(
                    data.connections?.filter(c => c.dst_country).map(c => c.dst_country)
                ).size;
                document.getElementById('metric-countries').textContent = countries;

                document.getElementById('metric-threats').textContent =
                    data.geo_intelligence?.threat_zones?.length || 0;

                document.getElementById('metric-db').textContent =
                    data.integration_status?.database || 'Unknown';

                document.getElementById('metric-queue').textContent =
                    data.metrics?.geo_queue_size || 0;

                // Update unknown locations
                updateUnknownLocations(data.connections || []);

                // Update threat zones
                updateThreatZones(data.geo_intelligence?.threat_zones || []);

                // Update connections
                updateConnections(data.connections || []);

                // Update map
                updateMap(data);

            } catch (error) {
                console.error('Update error:', error);
            }
        }

        function updateUnknownLocations(connections) {
            const container = document.getElementById('unknown-locations');
            const unknownConns = connections.filter(c => c.geo_failed === true);

            if (unknownConns.length === 0) {
                container.innerHTML = '<div style="color: #666; font-size: 11px;">All locations resolved</div>';
                return;
            }

            container.innerHTML = unknownConns.slice(0, 5).map(conn => `
                <div class="unknown-item">
                    <div>
                        <span class="unknown-ip">${conn.dst_ip}:${conn.dst_port}</span>
                    </div>
                    <div class="unknown-meta">
                        ${conn.dst_org || conn.dst_hostname || 'Geolocation failed'} • ${conn.protocol || 'TCP'}
                    </div>
                </div>
            `).join('');
        }

        function updateThreatZones(zones) {
            const container = document.getElementById('threat-zones');
            if (zones.length === 0) {
                container.innerHTML = '<div style="color: #666; font-size: 11px;">No active threats</div>';
                return;
            }

            container.innerHTML = zones.slice(0, 5).map(zone => `
                <div class="threat-zone">
                    <div>
                        <span class="threat-score">Threat: ${(zone.threat_score * 100).toFixed(0)}</span>
                    </div>
                    <div class="threat-location">
                        ${zone.lat.toFixed(2)}°, ${zone.lon.toFixed(2)}° • ${zone.radius_km}km radius
                    </div>
                </div>
            `).join('');
        }

        function updateConnections(connections) {
            const container = document.getElementById('connections');
            if (connections.length === 0) {
                container.innerHTML = '<div style="color: #666; font-size: 11px;">No connections</div>';
                return;
            }

            container.innerHTML = connections.slice(0, 8).map(conn => {
                const geoWarning = conn.geo_failed ? ' ⚠️' : '';
                return `
                    <div class="connection-item">
                        <div class="connection-header">
                            <span class="connection-ip">${conn.dst_ip}:${conn.dst_port}${geoWarning}</span>
                            <span class="connection-country">${conn.dst_country || '??'}</span>
                        </div>
                        <div class="connection-meta">
                            ${conn.dst_org ? conn.dst_org : (conn.dst_hostname || conn.protocol || 'TCP')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateMap(data) {
            // Efficient marker updates - only add/remove what changed
            const newThreatKeys = new Set();
            const newMarkerKeys = new Set();

            // Update threat zones (red circles)
            if (data.geo_intelligence?.threat_zones) {
                data.geo_intelligence.threat_zones.forEach((zone, idx) => {
                    const key = `threat_${zone.lat}_${zone.lon}`;
                    newThreatKeys.add(key);

                    if (!threatCircles.has(key)) {
                        const circle = L.circle([zone.lat, zone.lon], {
                            color: '#ff4444',
                            fillColor: '#ff4444',
                            fillOpacity: 0.2,
                            radius: zone.radius_km * 1000
                        }).addTo(map);

                        circle.bindPopup(`
                            <strong>Threat Zone</strong><br>
                            Score: ${(zone.threat_score * 100).toFixed(0)}<br>
                            Radius: ${zone.radius_km}km
                        `);

                        threatCircles.set(key, circle);
                    }
                });
            }

            // Remove old threat zones
            for (const [key, circle] of threatCircles.entries()) {
                if (!newThreatKeys.has(key)) {
                    map.removeLayer(circle);
                    threatCircles.delete(key);
                }
            }

            // Update connection markers
            if (data.connections) {
                // Separate known and unknown locations
                const knownConns = data.connections.filter(c => !c.geo_failed && c.dst_lat && c.dst_lon && (c.dst_lat !== 0 || c.dst_lon !== 0));
                const unknownConns = data.connections.filter(c => c.geo_failed);

                // Add/update green markers for known locations
                knownConns.slice(0, 50).forEach(conn => {
                    const key = `known_${conn.dst_ip}_${conn.dst_port}`;
                    newMarkerKeys.add(key);

                    if (!markers.has(key)) {
                        const marker = L.circleMarker([conn.dst_lat, conn.dst_lon], {
                            radius: 4,
                            color: '#00ff88',
                            fillColor: '#00ff88',
                            fillOpacity: 0.8,
                            weight: 1
                        }).addTo(map);

                        marker.bindPopup(`
                            <strong>${conn.dst_ip}</strong><br>
                            ${conn.dst_country || 'Unknown'}<br>
                            Port: ${conn.dst_port}
                        `);

                        markers.set(key, marker);
                    }
                });

                // Add/update orange markers for unknown locations
                unknownConns.slice(0, 10).forEach((conn, idx) => {
                    const key = `unknown_${conn.dst_ip}_${conn.dst_port}`;
                    newMarkerKeys.add(key);

                    if (!markers.has(key)) {
                        // Place them in the Atlantic Ocean near 0,0 but spread them out
                        const lat = 0 + (idx * 5);
                        const lon = 0 + (idx * 5);

                        const marker = L.circleMarker([lat, lon], {
                            radius: 5,
                            color: '#ffaa44',
                            fillColor: '#ffaa44',
                            fillOpacity: 0.9,
                            weight: 2
                        }).addTo(map);

                        marker.bindPopup(`
                            <strong>${conn.dst_ip}</strong> ⚠️<br>
                            Geolocation failed<br>
                            Port: ${conn.dst_port}<br>
                            ${conn.dst_org || conn.dst_hostname || ''}
                        `);

                        markers.set(key, marker);
                    }
                });
            }

            // Remove old markers that are no longer in the data
            for (const [key, marker] of markers.entries()) {
                if (!newMarkerKeys.has(key)) {
                    map.removeLayer(marker);
                    markers.delete(key);
                }
            }
        }

        // Initialize and update every 5 seconds
        updateDashboard();
        setInterval(updateDashboard, 5000);
    </script>
</body>
</html>
